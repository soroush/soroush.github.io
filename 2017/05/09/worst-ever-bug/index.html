<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fa-ir" lang="fa-ir">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.68.3" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>بدترین باگ کیوت! &middot; اختاپوس خسته</title>

  
  <link type="text/css" rel="stylesheet" href="http://soroush.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://soroush.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://soroush.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://soroush.github.io/css/hyde.css">
  <link type="text/css" rel="stylesheet" href="http://soroush.github.io/css/all.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_SVG">
</script> 
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    "HTML-CSS": {
    styles: {
        ".MathJax .mo, .MathJax .mi": {color: "black ! important"}
    }
    }
});
</script> 




</head>

  <body class=" layout-reverse">
  <aside class="sidebar">
  <div class="container sidebar-sticky-top">
    <div class="sidebar-about">
       <img style="border-radius:50%; background:#fafafa" src="http://soroush.github.io/static/images/octo.svg" alt="Avatar">
    </div>
  </div>
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://soroush.github.io/"><h1>اختاپوس خسته</h1></a>
      <p class="lead">
       یادداشت‌هایی دربارهٔ برنامه‌نویسی و زندگی 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://soroush.github.io/">صفحهٔ اول</a> </li>
        <li><a href="https://github.com/soroush/">&#x202d;<i class="fab fa-github"></i> soroush&#x202c;</a></li>
        
      </ul>
    </nav>

    <p>حقوق نشر محفوظ است.</p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>بدترین باگ کیوت!</h1>

  <time datetime=2017-05-09T00:00:00Z class="post-date">سه‌شنبه، ۱۹ اردیبهشت ۱۳۹۶</time>
  <p>کیوت به‌نظر من بهترین فریم‌ورک سی‌پلاس‌پلاس هست. یک کتابخانهٔ خیلی بزرگ با
امکانات بسیار عالی و خوب که محیط کاری KDE به‌طور کامل برپایهٔ اون ساخته شده.
اما از نسخهٔ 5.3 (ظاهراً) یک باگی به‌وجود آمده که زندگی رو برای ما خیلی سخت
کرده: عدم امکان وارد کردن نویسه‌های کنترلی و نیم‌فاصله‌های چسبان و غیرچسبان!
(قبلاً در مورد مورد
<a href="http://soroush.github.io/2014/09/18/unicode-bidi/">نویسه‌های کنترلی و جهت‌دهی متون فارسی/انگلیسی</a>
نوشتم.) حوزهٔ تأثیر این باگ به قدری بزرگ و
گسترده است که کار با محیط KDE رو برای ما غیرممکن کرده. تصور کنید که تقریباً هیچ
جایی توی سیستم‌عامل و برنامه‌های کاربردی محیط دسکتاپ نتونید نویسه‌های کنترلی و
فاصله‌ها رو تایپ کنید! توی این نوشته قصد دارم دلایل این باگ و روش برطرف کردنش و
همچنین روش دور زدن اون رو
توضیح بدم (: خوشبختانه روش فیکس خیلی ساده‌ست. و البته جای نگرانی نیست: نسخه‌های
فیکس با کیوت 5.8.1 (اگر ریلیز بشه) و یا 5.9.0 (در هر صورت) منتشر میشن. منتها
کسایی که نمی‌خوان تا اواسط 2018 صبر کنن که اون نسخه‌ها برای دبیان و اوبونتو
بیاد، خودشون می‌تونن با این روشی که توضیح میدم پچ کنن (:</p>
<h2 id="شروع-ماجرا">شروع ماجرا</h2>
<p>همه‌چیز توی کیوت به خوبی و خوشی پیش می‌رفت. نسخهٔ 5 تازه منشتر شده بود و چند تا
هم نسخهٔ minor خورده بود و همهٔ باگ‌های اساسی داشتن به مرور برطرف می‌شدن که
<a href="https://bugreports.qt.io/browse/QTBUG-35734">QTBUG-35734</a>
اتفاق افتاد. توی نسخهٔ 5.2 یک نفر گزارش کرد که کلیدهای کنترل و شیفت موقع تایپ
نویسه‌های نشانه‌گذاری آلمانی (مثل دونقطهٔ بالایی Ü) درست کار نمی‌کنن. فیکس
مربوطه خیلی ساده بود: حذف تمام نویسه‌های غیرقابل نمایش (چیزهایی که پرینت نمیشن)
که با شیفت یا کنترل و شیفت وارد میشن از ورودی‌های کیوت (تمام ورودی‌ها سابسیستم
ویجت‌ها). این
فیکس توی نسخهٔ 5.4 منتشر شد و الان که 5.8 رو داریم هنوز پابرجاست. نتیجه این که
محدودهٔ گسترده‌ای از نویسه‌های کنترلی جهت و نیم‌فاصله رو نمی‌تونیم با کلیدها
وارد کنیم. (البته می‌تونیم کپی کنیم از جای دیگه، ولی خوب به درد کی می‌خوره؟)</p>
<h2 id="برطرف-شدن-مشکل">برطرف شدن مشکل</h2>
<p>مشکل مربوطه توسط پنج نفر (که یکیش خودم باشم) به‌طور مستقل گزارش شده. اولین
گزارش
باگ به تاریخ ۲۹ مهر ۱۳۹۳ اینجا بود:
<a href="https://bugreports.qt.io/browse/QTBUG-42074">QTBUG-42074</a>
و چندین مورد هم مثل
<a href="https://bugreports.qt.io/browse/QTBUG-55608">QTBUG-55608</a>
و
<a href="https://bugreports.qt.io/browse/QTBUG-57302">QTBUG-57302</a>
و
<a href="https://bugreports.qt.io/browse/QTBUG-57003">QTBUG-57003</a>
و
<a href="https://bugreports.qt.io/browse/QTBUG-58364">QTBUG-58364</a>
بعدش گزارش شدن. ولی فیکس مربوطه میرسه به تاریخ ۲۸ دی ۱۳۹۵ ! یعنی ما دو سال
آزگار باید منتظر فیکس شدن این معضل می‌موندیم. منشأ این مشکل ضعف جامعهٔ کاربری
توسعه‌دهنده‌های ایرانی هست. وقتی سطح مشارکت ما این‌قدر پایین باشه و صرفاً دنبال
راه‌کارهای سودآور بدون صرف هیچ زمان و هزینه‌ای باشیم؛ اونوقت وضعیت‌مون میشه
همین. تازه مشکل با فیکس شدن باگ هم حل نمیشه! ما معمولاً از توزیع‌های مخازن
استفاده می‌کنیم که خیلی دیر به‌روز میشن. خیلی دیر یعنی این که نسخهٔ فعلی کیوت
توی مخازن اوبونتو برابر 5.6.1 هست، و نسخهٔ تصمیم‌گیری شده برای انتشار بعدی (شش
ماه بعد) 5.7.1 هست. یعنی حداقل باید برای رفع این مشکل یک سال دیگه (اون هم با
اما و اگر) صبر کنیم. کاربران دبیان اما شرایط بدتری دارند. کاربران ردهت خیلی
بدتر
از حتی دبیان!</p>
<h2 id="راهحلهای-غیررسمی">راه‌حل‌های غیررسمی</h2>
<p>تلگرام یک پچ غیررسمی روی کدهای کیوت منتشر کرد که به لطف این پچ می‌تونیم از
نویسه‌های نیم‌فاصله و نیم‌فاصلهٔ چسبان توی تلگرام استفاده کنیم. اما هنوز
نمی‌تونیم از تغییردهنده‌های جهت استفاده کنیم&hellip;</p>
<p>از طرفی هیچ توزیع لینوکسی هیچ وصله‌ای رو ارائه نکرده برای این مشکل. بنابراین
هرکسی با هر نسخه‌ای از کیوت که نصب داره، باید پچ خودش رو بنویسه؛ که از طرفی با
پچ‌های خود توزیع روی کیوت هم تداخل پیدا نکنه. خوب این کار رو من کردم و نتیجه
گرفتم. البته به‌صورت نصفه نیمه: فقط ویجت‌ها درست شدن. کیوت کوییک (مخصوصاً kate
که ظاهراً به همراه KF5 مهاجرت کرده به رابط کاربری جدید کیوت) مشکلش پابرجاست.
به‌زودی برای اون هم راه‌حلی پیدا می‌کنم.</p>
<p>راه حل من مبتنی بر اوبونتو هست که با کمترین تغییرات برای دبیان هم قابل اعمال
هست. روال مشابهی برای توزیع‌های دیگه باید انجام بشه.</p>
<p>برای حل این مشکل ما باید کتابخانهٔ Qt Core رو پچ کنیم. پچ کردن یا وصله زدن به
فرایند ایجاد تغییرات جزئی توی سورس اصلی یک بستهٔ نرم‌افزاری گفته میشه. ما این
کار رو کاملاً در چهارچوب طراحی و استانداردهای مخازن اوبونتو (و دبیان) انجام
خواهیم داد. برای این کار اول باید بسته‌های سورس کتابخانهٔ مورد نظر رو دانلود
کنیم:
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ ‌‌apt <span class="nb">source</span> libqt5core5a</code></pre></div>
این دستور بستهٔ نرم‌افزار حامل سورس کتابخانهٔ Qt Core رو به همراه تمام وصله‌های
مربوط به اوبونتو برای ما دانلود خواهد کرد. در مجموع چیزی حدود پنجاه مگابایت.
اگر به خروجی دقت کنید می‌بینید که آدرس رپوزیتوی گیت هم داده شده که بعداً
می‌تونیم از اون برای ارسال وصله برای ریلیز توی مخازن اوبونتو استفاده کنیم:</p>
<p><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ Reading package lists... Done
Picking <span class="s1">&#39;qtbase-opensource-src&#39;</span> as <span class="nb">source</span> package instead of <span class="s1">&#39;libqt5core5a&#39;</span>
NOTICE: <span class="s1">&#39;qtbase-opensource-src&#39;</span> packaging is maintained in the <span class="s1">&#39;Git&#39;</span> version 
control system at:
https://anonscm.debian.org/git/pkg-kde/qt/qtbase.git
Please use:
git clone https://anonscm.debian.org/git/pkg-kde/qt/qtbase.git
to retrieve the latest <span class="o">(</span>possibly unreleased<span class="o">)</span> updates to the package.
Need to get 47.5 MB of <span class="nb">source</span> archives.
Get:1 http://gb.archive.ubuntu.com/ubuntu xenial-updates/main/qtbase-opensource-src 5.5.1+dfsg-16ubuntu7.2 <span class="o">(</span>dsc<span class="o">)</span> <span class="o">[</span>5,096 B<span class="o">]</span>
Get:2 http://gb.archive.ubuntu.com/ubuntu xenial-updates/main/qtbase-opensource-src 5.5.1+dfsg-16ubuntu7.2 <span class="o">(</span>tar<span class="o">)</span> <span class="o">[</span>47.2 MB<span class="o">]</span>
...</code></pre></div>
خوب حالا سورس اصلی رو (بدون اعمال وصله‌ها) توی مسیر مربوطه داریم. الان باید
وصلهٔ خودمون رو اعمال کنیم. خوب من می‌دونم که مشکل مربوطه توی فایلی به اسم
<code>qwidgettextcontrol.cpp</code>
در مسیر
<code>src/widgets/widgets/</code>
هست. خوب به اون مسیر میرم و قسمت‌هایی که میخوام رو تغییر میدم. روش انجام این
تغییر مهم هست و باید به شکل اصولی انجام بشه تا قابل اشتراک گذاری با دیگران باشه:
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">cd</span> qtbase-opensource-src-5.5.1+dfsg/
$ <span class="nb">export</span> <span class="nv">QUILT_PATCHES</span><span class="o">=</span>debian/patches
$ quilt push -a
File series fully applied, ends at patch debian/patches/fix-duplicate-qnam-finished.patch
$ quilt new fix-non-printable-filters-for-persian-keyboard
Patch debian/patches/fix-non-printable-filters-for-persian-keyboard is now on top
$ quilt add src/widgets/widgets/qwidgettextcontrol.cpp 
File src/widgets/widgets/qwidgettextcontrol.cpp added to patch debian/patches/fix-non-printable-filters-for-persian-keyboard
$ quilt add src/widgets/widgets/qwidgetlinecontrol.cpp
File src/widgets/widgets/qwidgetlinecontrol.cpp added to patch debian/patches/fix-non-printable-filters-for-persian-keyboard</code></pre></div>
با این اجرای دستورات؛ فایل‌ها رو برای <strong>تعقیب تغییرات</strong> نشان‌گذاری می‌کنیم.
تعقیب تغییرات یعنی این که به سیستم میگیم که: حواست باشه کدوم قسمت از فایل رو به
چه شکلی تغییر میدم و در نهایت وقتی ازت پرسیدم چه کاری انجام شد، در فرمت
ازپیش‌تعریف‌‌شدهٔ patch، به من بگو که دقیقاً چه کارهایی انجام شد.</p>
<p>خوب، بعد از اصلاح فایل‌ها (اضافه کردن چند خط کد مربوط به شرط عدم پذیرش نویسه‌ها
که بعداً در موردش توضیح میدم) می‌رسیم به مرحله‌ای که می‌خواهیم وصلهٔ مربوطه رو
تشکیل بدیم و کدها رو کامپایل کنیم. برای درست کردن وصله باید دستورات زیر رو وارد
کنیم. با اجرای دستور اول وصله ساخته میشه و با اجرای دستور دوم تغییراتی که برای
ساخت وصله انجام داده بودیم، به حالت اول برگردانده میشه.
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ quilt refresh
$ quilt pop -a</code></pre></div>
خوب حالا طبق استاندارد باید یک واردهٔ جدید به فایل ChangeLog اضافه کنیم که
توضیحات مختصری در مورد وصله‌ای که ارائه دادیم رو داشته باشه. برای این کار
می‌تونیم به شکل دستی فایل مورد نظر رو ویرایش کنیم و یا از دستور <code>dch -i</code>
استفاده کنیم که کار رو برای ما راحت‌تر می‌کنه. این دستور از ما می‌پرسه ادیتور
موردعلاقه‌مون چیه و بعد با استفاده از اون ادیتور یک واردهٔ استاندارد به ابتدای
فایل ChangeLog اضافه می‌کنه. محتویات فایل ChangeLog در نهایت به‌صورت زیر خواهد
بود. (دقت کنید که نسخهٔ پکیج‌های ساخته شده دقیقاً یکی بیشتر از نسخهٔ پکیج اصلی)</p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">qtbase-opensource-src (5.5.1+dfsg-16ubuntu7.3) UNRELEASED; urgency=medium

  * Add a temporary workaround for QTBUG-42074

 -- Soroush Rabiei &lt;soroush@ametisco.ir&gt;  Tue, 09 May 2017 20:23:08 +0430
...</code></pre></div>
<p>بعد از این کار آمادهٔ کامپایل و نصب بسته هستیم. دستورات زیر این کار رو برای ما
انجام میدن:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nv">DEB_BUILD_OPTIONS</span><span class="o">=</span>nocheck debuild -us -uc -b -j10</code></pre></div>
<p>من اینجا تست‌های اتوماتیک رو با متغیر محیطی <code>DEB_BUILD_OPTIONS</code> غیرفعال کردم
چون نمی‌خوام بعد از کامپایل پکیج‌ها کلی وقت صرف تست اون‌ها بکنم. روال کامپایل
رو هم ده‌هسته‌ای تعریف کردم (قانون دو+تعداد هسته‌های پردازنده). بعد از حدود ده
دقیقه روی ماشین من (i7-6700) پکیج‌ها آمادهٔ نصب هستند و در دایرکتوری بالاتر
به‌صورت مجموعه‌ای از فایل‌های  .deb قابل دسترس هستند. البته این فایل‌ها توی
دایرکتوری بالاتر ایجاد میشن نه کنار سورس‌ها. من این‌ها رو میذارم توی یک
رپوزیتوری شخصی که از پکیج‌هام درست کردم که بعداً هم بتونم نصبشون کنم. البته
می‌تونم مستقیماً با این دستور پکیج‌های ساخته شده رو نصب کنم:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">cd</span> .. <span class="c1"># برای رفتن به دایرکتوری بالاتر</span>
$ sudo debi <span class="c1"># برای نصب پکیج‌های تولید شده</span></code></pre></div>
<h2 id="نتایج">نتایج</h2>
<p>خوب حالا با خیال راحت توی برنامه‌های ویجتی کیوت می‌تونم از نیم‌فاصله و کاراکترهای کنترلی
استفاده کنم:</p>
<!-- raw HTML omitted -->
<h2 id="پینوشت-وصلهها">پی‌نوشت: وصله‌ها</h2>
<p>خوب وصله‌ای که من برای ویجت‌ها به‌کار بردم این‌طور عمل می‌کنه: یک لیست سفید از
نویسه‌هایی که نباید توی شرط مربوط به فیکس 35724 فیلتر بشن رو اضافه می‌کنم و هر
سری که چیزی توی متن نوشته شد بررسی میشه که اگر شرط 35724 صدق کنه <strong>یا</strong> کاراکتر
توی لیست سفید باشه؛ در این‌صورت اون رو می‌نویسه. وصلهٔ مربوطه این هست:</p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff"><span class="gh">Index: 
</span><span class="gh"></span>qtbase-opensource-src-5.5.1+dfsg/src/widgets/widgets/qwidgetlinecontrol.cpp
<span class="gh">===================================================================
</span><span class="gh"></span><span class="gd">--- 
</span><span class="gd"></span>qtbase-opensource-src-5.5.1+dfsg.orig/src/widgets/widgets/qwidgetlinecontrol.cpp
<span class="gi">+++ qtbase-opensource-src-5.5.1+dfsg/src/widgets/widgets/qwidgetlinecontrol.cpp 
</span><span class="gi"></span> 
                                                                            
<span class="gu">@@ -1884,7 +1884,11 @@ void QWidgetLineControl::processKeyEvent                 
</span><span class="gu"></span> 
                                                                            
         &amp;&amp; event-&gt;modifiers() != Qt::ControlModifier                           
 
                                                                            
         &amp;&amp; event-&gt;modifiers() != (Qt::ControlModifier | Qt::ShiftModifier)) {
         QString t = event-&gt;text();
<span class="gd">-        if (!t.isEmpty() &amp;&amp; t.at(0).isPrint()) {
</span><span class="gd"></span><span class="gi">+        ushort code = 0;
</span><span class="gi">+        if(!t.isEmpty())
</span><span class="gi">+            code = t.at(0).unicode();
</span><span class="gi">+        if (!t.isEmpty() &amp;&amp;
</span><span class="gi">+            (t.at(0).isPrint() || (0x2000 &lt;= code &amp;&amp; code &lt;= 0x200F) || (0x2028 &lt;= code &amp;&amp; code &lt;= 0x202F))) {
</span><span class="gi"></span>             insert(t);
 #ifndef QT_NO_COMPLETER
             complete(event-&gt;key());
<span class="gh">Index: 
</span><span class="gh"></span>qtbase-opensource-src-5.5.1+dfsg/src/widgets/widgets/qwidgettextcontrol.cpp
<span class="gh">===================================================================
</span><span class="gh"></span><span class="gd">--- 
</span><span class="gd"></span>qtbase-opensource-src-5.5.1+dfsg.orig/src/widgets/widgets/qwidgettextcontrol.cpp
<span class="gi">+++ qtbase-opensource-src-5.5.1+dfsg/src/widgets/widgets/qwidgettextcontrol.cpp
</span><span class="gi"></span><span class="gu">@@ -1342,13 +1342,19 @@ void QWidgetTextControlPrivate::keyPress
</span><span class="gu"></span> process:
     {
         // QTBUG-35734: ignore Ctrl/Ctrl+Shift; accept only AltGr (Alt+Ctrl) on German keyboards
<span class="gd">-        if (e-&gt;modifiers() == Qt::ControlModifier
</span><span class="gd"></span><span class="gi">+        /* if (e-&gt;modifiers() == Qt::ControlModifier
</span><span class="gi"></span>             || e-&gt;modifiers() == (Qt::ShiftModifier | Qt::ControlModifier)) {
             e-&gt;ignore();
             return;
         }
<span class="gi">+        */
</span><span class="gi"></span>         QString text = e-&gt;text();
<span class="gd">-        if (!text.isEmpty() &amp;&amp; (text.at(0).isPrint() || text.at(0) == 
</span><span class="gd"></span>QLatin1Char(&#39;\t&#39;))) {
<span class="gi">+        ushort code = 0;
</span><span class="gi">+        if(!text.isEmpty())
</span><span class="gi">+            code = text.at(0).unicode();
</span><span class="gi">+        if (!text.isEmpty()
</span><span class="gi">+                &amp;&amp; (text.at(0).isPrint() || text.at(0) == QLatin1Char(&#39;\t&#39;)
</span><span class="gi">+                    || (0x2000 &lt;= code &amp;&amp; code &lt;= 0x200F) || (0x2028 &lt;= code &amp;&amp; code &lt;= 0x202F))) {
</span><span class="gi"></span>             if (overwriteMode // no need to call deleteChar() if we have a selection, insertText
                 // does it already
</code></pre></div>
<h2 id="پینوشت-۲-کارهای-باقیمانده">پی‌نوشت ۲: کارهای باقی‌مانده</h2>
<p>با اِعمال این وصله، باگ مربوطه در زمینهٔ ویجت‌ها برطرف شده؛ اما باگ مشابهی هنوز
توی Qt Quick وجود داره. این باگ باعث میشه اون دسته از برنامه‌های KDE که به سیستم
جدید KF5 مهاجرت کردن هنوز این مشکل رو داشته باشن. هنوز نمی‌دونم فیکسش چطور
هست. بهرحال اگر پیداش کنم، به‌همراه وصلهٔ ویجت‌ها منتشرش می‌کنم. اگر به نسخهٔ رپوزیتوری
نرسه (که با توجه به سنگین بودن کیوت امکان پذیرشش کم هست) این فیکس‌ها رو داخل یک
PPA
منتشر می‌کنم.</p>
</div>

<h2>دیدگاه‌ها</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "soroushr" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
  </body>
</html>
