<!doctype html><html xmlns=http://www.w3.org/1999/xhtml><head><link href=//gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.68.3"><meta name=viewport content="width=device-width,initial-scale=1"><title>مشکل نیم‌فاصله در KDE و روش حل آن &#183; اختاپوس خسته</title><link type=text/css rel=stylesheet href=https://soroush.github.io/fa/css/print.css media=print><link type=text/css rel=stylesheet href=https://soroush.github.io/fa/css/poole.css><link type=text/css rel=stylesheet href=https://soroush.github.io/fa/css/syntax.css><link type=text/css rel=stylesheet href=https://soroush.github.io/fa/css/hyde.css><link type=text/css rel=stylesheet href=https://soroush.github.io/fa/css/all.css><link type=text/css rel=stylesheet href=https://soroush.github.io/fa/css/hyde-rtl.css><link type=text/css rel=stylesheet href=https://soroush.github.io/fa/css/poole-rtl.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_SVG"></script><script type=text/x-mathjax-config>
MathJax.Hub.Config({
    "HTML-CSS": {
    styles: {
        ".MathJax .mo, .MathJax .mi": {color: "black ! important"}
    }
    }
});
</script></head><body class=layout-reverse><aside class=sidebar><div class="container sidebar-sticky-top"><div class=sidebar-about><img style=border-radius:50%;background:#fafafa src=https://soroush.github.io/fa//static/images/octo.svg alt=Avatar></div></div><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://soroush.github.io/fa/><h1>اختاپوس خسته</h1></a><p class=lead>یادداشت‌هایی دربارهٔ برنامه‌نویسی و زندگی</p></div><nav><ul class=sidebar-nav><li><a href=https://github.com/soroush/>&#8237;<i class="fab fa-github"></i> soroush&#8236;</a></li></ul></nav><p>حق نشر محفوظ است.</p></div></aside><main class="content container"><div class=post><h1>مشکل نیم‌فاصله در KDE و روش حل آن</h1><time datetime=2017-12-18T00:00:00Z class=post-date>دوشنبه، ۲۷ آذر ۱۳۹۶</time><p>قبلاً در مورد
<a href=https://soroush.github.io/fa/1396/02/19/worst-ever-bug/>باگ بسیار بدی</a>
که در کیوت به‌وجود آمده بود و روش حل آن نوشتم. این
باگ باعث میشد امکان نوشتن نویسه‌های کنترلی مثل نیم‌فاصله و تغییر جهت
به‌طور کامل از بین بره. (اگر از نیم‌فاصله استفاده نمی‌کنید و یا نمی‌دونید تغییر
جهت متن چه اهمیتی داره حتماً
<a href=https://soroush.github.io/fa/1393/06/27/unicode-bidi/>نویسه‌های کنترلی و جهت‌دهی متون فارسی/انگلیسی</a>
رو بخونید)</p><p>الآن با گذشت چند ماه باگ مربوطه برطرف شده و با نسخهٔ 5.9.1 منتشر شده.
(تغیرات گریت برای ماژول qtbase
<a href=https://codereview.qt-project.org/#/c/179219/>اینجا</a>
و برای ماژول qtdeclarative
<a href=https://codereview.qt-project.org/#/c/179258/>اینجا</a>
قابل مشاهده هستند)
خوشبختانه برنامه‌های کیوت دیگه مشکل سابق رو ندارند و هم توی ماژول widgets و هم
توی ماژول جدیدتر Qt Quick مشکل به‌طور کامل برطرف شده. خوب حداقل من این‌طور فکر
می‌کردم!</p><p>با به‌روز کردن سیستم به نسخهٔ جدیدتر الان از کیوت نسخهٔ 5.9.1 استفاده می‌کنم که
خوب باگش برطرف شده. اما در کمال تعجب می‌بینم که هنوز نمی‌تونم توی محیط‌های متنی
KDE
مثل kate و یا kwrite فارسی بنویسم! اولش کلی گیج شدم. فکر کردم باگ برطرف نشده.
با مراجعه به صفحهٔ گریت دیدم برطرف شده. ولی خوب kate هنوز نمی‌تونه نیم‌فاصله
بنویسه. بعد فکر کردم شاید از نسخهٔ اصلاح‌شدهٔ کیوت استفاده نمی‌کنن، که دیدم
این‌طوری هم نیست. آخرش با کیوت یه برنامهٔ ویجتی نوشتم و دیدم نیم‌فاصله به راحتی
درج میشه. بعد به این نتیجه رسیدم که خوب حتماً مشکل توی ماژول Qt Quick اصلاح
نشده، یه تست دیگه با QML نوشتم و دیدم اونجا هم مشکل نداره! خوب پس چرا kate
نمی‌تونه نیم‌فاصله بنویسه؟</p><p>بعد از مطالعهٔ ده‌ها پکیج مربوط به KDE (از کتابخانه‌های libkf5 تا خود سورس
kate
) بالأخره مشکل رو پیدا کردم. دقیقا مثل کیوت یک فیلتر برای حذف نویسه‌های غیر
قابل چاپ از ورودی اضافه شده. خوب وقتی کیوت این ویژگی رو داشت چرا توسعه‌دهندهٔ
KDE
لازم دیده اضافه‌ش کنه؟ این رو باید از خود توسعه‌دهنده‌ها پرسید. بهرحال
نویسندهٔ این سورس فرض کرده هیچ نویسهٔ یونیکدی که نمایش تصویری نداشته باشه
شایستگی درج در متن رو نداره. مگر دو تا استثنا: tab و space. خوب من فقط
نیم‌فاصله‌ها و کاراکترهای کنترل جهت رو به این استثنا اضافه کردم. با این پچ مشکل
من در KDE به‌طور کامل حل شد. اما مطمئن هستم کسانی که توی کشورهای دیگه زندگی
می‌کنند و نیاز به درج کاراکترهای خاص‌تری رو دارند همچنان مشکلاتی خواهند داشت.
کار بهتر می‌تونه حذف کامل این فیلتر و پیاده‌سازی منطق مربوطه به شکل دیگه باشه.
چند ماه آینده شاید بتونم وقتی پیدا کنم که این کار رو انجام بدم. فعلاً اما این
پچ کار رو راه می‌اندازه. مراحل قدم‌به‌قدم و پچ نهایی در ادامه نوشته شده.</p><h2 id=رفع-باگ>رفع باگ</h2><p>محیط کاری من KDE (نسخهٔ اوبونتو 17.10) هست. اگر از توزیع‌های دیگهٔ مبتنی‌بر
دبیان یا خود دبیان استفاده می‌کنید مراحل کار تقریباً مشابه خواهد بود.</p><p>اول باید پکیج‌های زیر رو نصب کنید. این‌ها اسکریپت‌های کمکی برای ایجاد و تغییر
محتوای پکیج‌های deb هستند.<div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ sudo apt install quilt devscripts </code></pre></div></p><p>تعداد زیادی از پکیج‌های توسعهٔ KDE و کیوت رو هم نیاز خواهید داشت. من لیست
معقولی از این پکیج‌ها رو پایین آوردم، اما خوب کامپایلر و باقی پیش‌نیازهای بدیهی
رو فرض کردم که از قبل نصب کرده‌اید:</p><p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ sudo apt install debhelper extra-cmake-modules libeditorconfig-dev 
libgit2-dev libkf5archive-dev libkf5config-dev libkf5guiaddons-dev 
libkf5i18n-dev libkf5iconthemes-dev libkf5kio-dev libkf5parts-dev 
libkf5sonnet-dev libkf5syntaxhighlighting-dev libqt5xmlpatterns5-dev 
pkg-kde-tools qtdeclarative5-dev qtscript5-dev </code></pre></div>در مرحلهٔ بعد شما باید پکیج سورس کتابخانه‌ای رو دانلود کنید که شامل ادیتورهای
متنی فریم‌ورک KDE هست. برای این کار:<div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ apt <span class=nb>source</span> ktexteditor</code></pre></div>بعد محیط رو برای ایجاد تغییرات (مثل قبل) آماده می‌کنیم:<div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>cd</span> ktexteditor-5.38.0/
$ <span class=nb>export</span> <span class=nv>QUILT_PATCHES</span><span class=o>=</span>debian/patches
$ quilt push -a
$ quilt add ./src/document/katedocument.cpp</code></pre></div>بعد فایل <code>‪./src/document/katedocument.cpp‬</code> رو تغییر میدیم و فیلترهای مربوطه
رو اضافه می‌کنیم. و یا می‌تونید از پچی که پایین نوشتم استفاده کنید.</p><p>در نهایت (بازم مثل قبل) کامپایل و نصب پکیج رو انجام میدیم:<div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ quilt refresh
$ quilt pop -a
$ <span class=nv>DEB_BUILD_OPTIONS</span><span class=o>=</span>nocheck debuild -us -uc -b -j10
$ sudo debi </code></pre></div>در ادامه شما می‌تونید از تایپ فارسی در محیط متنی KDE و هر برنامه‌ای که از اون
استفاده می‌کنه (مثل kate) لذت ببرید (:<figure><img src=/static/images/kate.png><figcaption><h4>باگ برطرف شده</h4></figcaption></figure><figure><img src=/static/images/wiki.png><figcaption><h4>باگ برطرف شده</h4></figcaption></figure></p><h2 id=وصله>وصله</h2><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff><span class=gd>----	2017-12-18 16:53:03.435719378 +0330
</span><span class=gd></span><span class=gi>+++ 
</span><span class=gi></span>/home/soroush/workspace/kate-bugfix/ktexteditor-5.38.0/src/document/katedocument
.cpp	2017-12-18 16:50:09.000000000 +0330
<span class=gu>@@ -2904,8 +2904,7 @@
</span><span class=gu></span>     const auto realUcs4Chars = realChars.toUcs4();
     QVector&lt;uint&gt; ucs4Chars;
     Q_FOREACH (auto c, realUcs4Chars)
<span class=gd>-        if (QChar::isPrint(c) || c == QChar::fromLatin1(&#39;\t&#39;) || c == 
</span><span class=gd></span>QChar::fromLatin1(&#39;\n&#39;) || c == QChar::fromLatin1(&#39;\r&#39;)
<span class=gd>-            || (0x2000 &lt;= c &amp;&amp; c &lt;= 0x200F) || (0x2028 &lt;= c &amp;&amp; c &lt;= 0x202F) ) {
</span><span class=gd></span><span class=gi>+        if (QChar::isPrint(c) || c == QChar::fromLatin1(&#39;\t&#39;) || c == 
</span><span class=gi></span>QChar::fromLatin1(&#39;\n&#39;) || c == QChar::fromLatin1(&#39;\r&#39;)) {
             ucs4Chars.append(c);
         }
</code></pre></div><h2 id=مشکلات-باقیمانده>مشکلات باقی‌مانده</h2><p>چند تا مشکل کوچیک هنوز هست که باید برطرف بشه. یکی این که تمام نویسه‌های فیلتر
شده، شمرده نخواهند شد. یعنی اگر شما مثلا بنویسید «ل» بعد یک نیم‌فاصله بزنید، و
بنویسید «م»، نیم‌فاصله اون وسط جا می‌گیره. اما اگر یکی به عقب برگردید و
Backspace
بزنید، هم نیم‌فاصله و هم «ل» پاک میشن. خیلی باگ بدی نیست. این هفته سعی خواهم
کرد این رو هم درست کنم.</p></div><h2>دیدگاه‌ها</h2><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"khtpws-khsth"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main></body></html>